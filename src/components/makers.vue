<template>
  <div id="makers">
    <modal height="auto" adaptive :clickToClose="isFalse" name="loading">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 p-5 text-center">
            <div class="spinner-grow text-primary" style="width: 6rem; height: 6rem;" role="status">
              <span class="sr-only">Chargement...</span>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal height="auto" adaptive name="error">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>😨 Quelque chose n'as pas marché</h1>
              </div>
            </div>
            <div class="row bg-success pt-4 h-100">
              <div class="col-12 pt-2 pb-3 text-white text-center">
                <p>Essais plus tard</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal height="auto" adaptive name="added">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 h-100">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>🏄‍♂️ Ajout pris en compte</h1>
              </div>
            </div>
            <div class="row bg-success pt-4 h-100">
              <div class="col-12 pt-2 text-white text-center">
                <p>N'hésite pas a twitter pour motiver ce·tte Maker à venir sur le podcast !</p>
                <p>J'ai supposé que tu voulais aussi voter pour lui/elle, alors c'est fait .✅</p>
                <p class="font-weight-bold">Voici un message tout pret pour l'inviter 😎</p>
                <p>Quand l'épisode sortira je t'enverrais un email pour te remercier et te partager l'épisode qui existe grâce a toi.💃</p>
              </div>
              <div class="offset-md-3 col-md-6 pt-0 pb-3 text-white text-center">
                <button
                  type="button"
                  class="btn btn-primary btn-lg btn-block text-light px-4 h1"
                  @click="tweetIt()"
                >🦚Voir</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal adaptive height="auto" name="fail-add">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 h-100">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>👀Je ne trouve pas ce·tte Maker</h1>
              </div>
            </div>
            <div class="row bg-success pt-4 h-100">
              <div class="col-12 pt-2 text-white text-center">
                <p>Je ne peut pas ajouter de Maker qui n'est pas sur Twitter pour le moment.</p>
              </div>
              <div class="offset-md-3 col-md-6 pt-0 pb-3 text-white text-center">
                <button
                  type="button"
                  class="btn btn-primary btn-lg btn-block text-light px-4 h1"
                  @click="$modal.hide('fail-add')"
                >Fermer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal adaptive height="auto" name="fail-vote">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 h-100">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>😨 Hoho</h1>
              </div>
            </div>
            <div class="row bg-success pt-4 h-100">
              <div class="col-12 pt-2 text-white text-center">
                <p>tu as deja voté pour ce·tte Maker</p>
                <p>Tu peux toujour twitter pour motiver ce·tte Maker à venir sur le podcast !</p>
                <p class="font-weight-bold">Voici un message tout pret pour l'inviter 😎</p>
              </div>
              <div class="offset-md-3 col-md-6 pt-0 pb-3 text-white text-center">
                <button
                  type="button"
                  class="btn btn-primary btn-lg btn-block text-light px-4 h1"
                  @click="tweetIt(name)"
                >🦚Voir</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal adaptive height="auto" name="fail-exist">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 h-100">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>😝 OUPS</h1>
              </div>
            </div>
            <div class="row bg-success pt-4 h-100">
              <div class="col-12 pt-2 text-white text-center">
                <p>Ce·tte maker est déjà présent dans la liste, J'ai ajouté ton vote pour lui/elle.</p>
                <p>Tu peux toujour twitter pour motiver ce·tte Maker à venir sur le podcast !</p>
                <p class="font-weight-bold">Voici un message tout pret pour l'inviter 😎</p>
              </div>
              <div class="offset-md-3 col-md-6 pt-0 pb-3 text-white text-center">
                <button
                  type="button"
                  class="btn btn-primary btn-lg btn-block text-light px-4 h1"
                  @click="tweetIt()"
                >🦚Voir</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal adaptive height="auto" name="fail-exist-vote">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 h-100">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>😝 OUPS</h1>
              </div>
            </div>
            <div class="row bg-success pt-4 h-100">
              <div class="col-12 pt-2 text-white text-center">
                <p>Ce·tte maker est déjà présent dans la liste, et tu as déjà voté pour lui/elle 😇.</p>
                <p>Tu peux toujour twitter pour motiver ce·tte Maker à venir sur le podcast !</p>
                <p class="font-weight-bold">Voici un message tout pret pour l'inviter 😎</p>
              </div>
              <div class="offset-md-3 col-md-6 pt-0 pb-3 text-white text-center">
                <button
                  type="button"
                  class="btn btn-primary btn-lg btn-block text-light px-4 h1"
                  @click="tweetIt()"
                >🦚Voir</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal height="auto" adaptive name="add">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 h-100">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>➕Ajouter un·e Maker</h1>
              </div>
            </div>
            <div class="row bg-success pt-4">
              <div class="col-12 pt-2 text-white text-center">
                <p>Saisie le nom de son compte Twitter</p>
              </div>
              <div class="offset-md-3 col-md-6 pt-3 text-white text-center">
                <div class="form-group mb-0">
                  <input
                    ref="addMaker"
                    type="text"
                    v-model="addName"
                    class="form-control pb-0"
                    aria-describedby="TweetnameHelp"
                    placeholder="elonmusk"
                    v-on:keyup.enter="add()"
                  />
                </div>
              </div>
              <div class="offset-md-3 col-md-6 pt-0 pb-3 text-white text-center">
                <button
                  type="button"
                  class="btn btn-primary btn-lg btn-block text-light px-4 h1"
                  @click="add()"
                >Ajouter</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal height="auto" adaptive name="voted">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 h-100">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>💪Vote pris en compte</h1>
              </div>
            </div>
            <div class="row bg-success pt-4 h-100">
              <div class="col-12 pt-2 text-white">
                <p>N'hésite pas a twitter pour motiver ce·tte Maker à venir sur le podcast !</p>
                <p class="font-weight-bold">Voici un message tout pret pour l'inviter 😎</p>
                <p>Quand l'épisode sortira je t'enverrais un email pour te remercier et te partager l'épisode qui existe grâce a toi.💃</p>
              </div>
              <div class="offset-md-3 col-md-6 pt-0 pb-3 text-white text-center">
                <button
                  type="button"
                  class="btn btn-primary btn-lg btn-block text-light px-4 h1"
                  @click="tweetIt()"
                >🦚Voir</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal height="auto" adaptive name="checkEmail">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 h-100">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>✅Check ta boite email</h1>
              </div>
            </div>
            <div class="row bg-success pt-4">
              <div class="col-12 pt-2 text-white text-center">
                <p>Récupère ton lien de login reçût par email et click dessus, c'est tout❤️</p>
              </div>
              <div class="offset-md-3 col-md-6 pt-3 pb-3 text-white text-center">
                <button
                  type="button"
                  class="btn btn-primary btn-lg btn-block text-light px-4 h1"
                  @click="$modal.hide('checkEmail')"
                >😎Cool</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <modal height="auto" adaptive name="register">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 h-100">
            <div class="row bg-primary py-2">
              <div class="col-12 pt-2 text-white text-center">
                <h1>🔐Pas tout de suite !</h1>
              </div>
            </div>
            <div class="row bg-success pt-4">
              <div class="col-12 pt-2 text-white">
                <p>Pour pouvoir te tenir au courant de la sortie de l'épisode et éviter les faux votes</p>
                <h5 class="text-center">j’ai besoin que tu valides ton email</h5>
                <p>Tu ne recevras des emails seulement pour les makers pour qui tu as voté, et si j'ai une grande nouvelle a te partager (max 3 par ans).</p>
                <p>Et bien entendu, je ne refile ton e-mail à personne, je déteste ceux qui font ça !</p>
              </div>
            </div>
            <div class="row bg-success">
              <div class="offset-md-3 col-md-6 pt-3 text-white text-center">
                <div class="form-group mb-0">
                  <input
                    ref="register"
                    type="email"
                    v-model="email"
                    class="form-control pb-0"
                    aria-describedby="emailHelp"
                    placeholder="elon@musk.com"
                    v-on:keyup.enter="sendLogin()"
                  />
                </div>
              </div>
              <div class="offset-md-3 col-md-6 pt-0 pb-3 text-white text-center">
                <button
                  type="button"
                  class="btn btn-primary btn-lg btn-block text-light px-4 h1"
                  @click="sendLogin()"
                >🚀VALIDER</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </modal>
    <div class="container-fluid">
      <div class="row pt-md-5">
        <div class="col-12 offset-xl-1 col-xl-5">
          <div class="row bg-primary border-10 border-light py-1 py-md-4">
            <div class="col col-md-10 pt-3 px-0 text-white text-center">
              <h1>🔥Makers</h1>
            </div>
            <div class="col-3 col-md-2 pt-3 text-white">
              <button
                type="button"
                class="btn btn-primary btn-lg border-5 border-light text-light px-3 px-md-4 display-1"
                v-tooltip="'Ajouter un·e maker'"
                @click="showAddForm()"
              >
                <strong>+</strong>
              </button>
            </div>
          </div>
          <div class="row bg-white px-3" v-if="loading">
            <div class="col-12 p-5 text-center">
              <div
                class="spinner-grow text-primary"
                style="width: 6rem; height: 6rem;"
                role="status"
              >
                <span class="sr-only">Chargement...</span>
              </div>
            </div>
          </div>
          <div
            class="custom-scroll border-5 px-2 border-light border-right-0"
            v-if="!loading"
            v-bind:style="{ height: heightDiv }"
          >
            <div
              v-bind:key="person.id"
              v-for="person in people"
              :class="'row bg-primary text-white py-3 border-bottom align-items-center ' + person.id"
            >
              <div class="col-12 d-block d-sm-none">
                <h3 >{{person.name}}</h3>
              </div>
              <div class="col-4 pr-0 pr-md-5">
                <img
                  :src="personImg(person)"
                  @onerror="imgUrlAlt"
                  class="w-100 w-md-75 img-fluid border-5 border-light"
                  alt="Logo person"
                />
              </div>
              <div class="col-5 col-md-6">
                <h3 class="d-none d-sm-block" >{{person.name}}</h3>
                <div>
                  <p
                    @click="openAccount(person.login)"
                    v-tooltip="'Ouvrir son profils Twitter'"
                    class="text-secondary fit-content cursor-pointer"
                  >@{{person.login}}</p>
                </div>
              </div>
              <div class="col-3 col-md-2 pl-0" @click="vote(person)">
                <button
                  type="button"
                  class="btn btn-primary border-5 border-light btn-lg text-white px-3 px-md-4 py-3 h1"
                  v-tooltip="tooltipVote(person)"
                >
                  <!-- <div>&#9650;</div> -->
                  <i class="fas fa-caret-circle-right fa-2x invisible"></i>
                  <div class="position-absolute ml-2 top">
                    <i class="fas fa-caret-up fa-2x"></i>
                    <p>{{person.votes}}</p>
                  </div>
                </button>
              </div>
              <div class="col-12 px-md-5 pt-3">
                <p class v-html="getTextLink(person.bio)"></p>
              </div>
            </div>
          </div>
        </div>
        <div v-if="image" class="col-12 col-md-6 pt-0 px-md-5 order-1 order-md-2 d-none d-xl-block">
          <img class="img-fluid border-10 border-light" :alt="image.title" :src="image.url" />
        </div>
      </div>
    </div>
  </div>
</template>

<script>
/*eslint no-console: ["error", { allow: ["warn", "error"] }] */
// import illu from "./illu.vue";
import Vue from "vue";
import { db, firebaseLib } from "../utils/db";
import linkifyHtml from "linkifyjs/html";
import Tooltip from "vue-directive-tooltip";
import "vue-directive-tooltip/dist/vueDirectiveTooltip.css";
import { firestorePlugin } from "vuefire";
import VModal from "vue-js-modal";
const Parser = require('rss-parser');
const parser = new Parser();
const RSSURL = 'https://cors-anywhere.herokuapp.com/https://anchor.fm/s/414d1d4/podcast/rss';

Vue.use(Tooltip);
Vue.use(VModal);
Vue.use(firestorePlugin);

const addTwiterUser = firebaseLib.functions().httpsCallable("addTwiterUser");

export default {
  // components: {
  //   illu
  // },
  methods: {
    tooltipVote(person) {
      return `Voter pour avoir ${person.name} dans le podcast`;
    },
    personImg(person) {
      return `https://twitter-avatar.now.sh/${person.login}`;
    },
    imgUrlAlt(event) {
      event.target.src = `assets/profile.png`;
    },
    tweetIt() {
      const text = `@${this.currentName}, j'aimerais beaucoup que tu sois le·a prochain invité·e du podcast @indiemakersfr 🚀.`;
      window.open(`https://twitter.com/intent/tweet?text=${text}`, "_blank");
      this.$modal.hide("added");
      this.$modal.hide("voted");
    },
    getTextLink(text) {
      return linkifyHtml(text, {
        defaultProtocol: "https",
        className: "linkified",
        ignoreTags: [],
        format: function(value, type) {
          let newVal = value + "";
          if (type === "url" && newVal.indexOf("https://") !== -1) {
            newVal = newVal.replace("https://", "");
          } else if (type === "url" && newVal.indexOf("http://") !== -1) {
            newVal = newVal.replace("http://", "");
          }
          if (type === "url" && newVal.length > 50) {
            newVal = newVal.slice(0, 50) + "…";
          }
          return newVal;
        },
        nl2br: true,
        tagName: "a",
        target: {
          url: "_blank"
        },
        validate: true
      });
    },
    sendLogin() {
      if (this.email) {
        window.localStorage.setItem("emailForSignIn", this.email);
        const actionCodeSettings = {
          url: "https://indiemakers.fr/#/login",
          handleCodeInApp: true
        };
        this.$modal.hide("register");
        this.$modal.show("loading");
        firebaseLib
          .auth()
          .sendSignInLinkToEmail(this.email, actionCodeSettings)
          .then(() => {
            window.localStorage.setItem("emailForSignIn", this.email);
            this.$modal.hide("loading");
            this.$modal.show("checkEmail");
          })
          .catch(error => {
            this.$modal.hide("loading");
            console.error(error);
          });
      }
    },
    vote(person) {
      if (!this.loggin) {
        this.openRegister();
      } else {
        this.$modal.show("loading");
        db.collection(`people/${person.id}/votes`)
          .doc(this.loggin.uid)
          .set({
            date: Date()
          })
          .then(() => {
            this.$modal.hide("loading");
            person.votes += 1;
            this.currentName = "" + person.login;
            this.$modal.show("voted");
          })
          .catch(error => {
            this.$modal.hide("loading");
            console.error("Error writing document: ", error);
            this.currentName = "" + person.login;
            this.$modal.show("fail-vote");
          });
      }
    },
    openRegister() {
      this.$modal.show("register");
      setTimeout(() => {
        this.$refs.register.focus();
      }, 50);
    },
    openAdd() {
      this.$modal.show("add");
      setTimeout(() => {
        this.$refs.addMaker.focus();
      }, 50);
    },
    showAddForm() {
      if (!this.loggin) {
        this.openRegister();
      } else {
        this.openAdd();
      }
    },
    openAccount(name) {
      window.open(`https://twitter.com/${name}`, "_blank");
    },
    add() {
      this.$modal.hide("add");
      this.$modal.show("loading");
      if (!this.loggin) {
        this.$modal.hide("loading");
        this.openRegister();
      } else {
        addTwiterUser({ name: this.addName })
          .then(addJson => {
            const added = addJson.data;
            this.$modal.hide("loading");
            if (added.error && added.error === "Already voted") {
              this.currentName = "" + this.addName;
              this.$modal.show("fail-exist-vote");
            } else if (added.error) {
              console.error(added);
              this.$modal.show("fail-add");
            } else if (added.done && added.done === "Voted") {
              this.currentName = "" + this.addName;
              this.$modal.show("fail-exist");
            } else {
              this.currentName = "" + this.addName;
              this.$modal.show("added");
            }
            this.addName = "";
          })
          .catch(err => {
            this.$modal.hide("loading");
            this.$modal.show("error");
            console.error(err);
          });
      }
    },
    setSizeHead() {
      if (document.getElementById("app")) {
        this.sizeHead = document.getElementById("app").offsetHeight;
      }
    }
  },
  data() {
    return {
      email: "",
      image: null,
      isFalse: false,
      loggin: false,
      loading: true,
      sizeHead: 0,
      addName: "",
      currentName: "",
      people: []
    };
  },
  computed: {
    heightDiv() {
      if (this.sizeHead === 0) {
        return 0;
      }
      return `calc(100vh - ${this.sizeHead}px)`;
    }
  },
  mounted() {
    this.loggin = firebaseLib.auth().currentUser;
    this.email = window.localStorage.getItem("emailForSignIn");
    this.$bind(
      "people",
      db
        .collection("people")
        .orderBy("votes", "desc")
        .orderBy("addDate", "asc")
    )
      .then(() => {
        this.loading = false;
        setTimeout(() => {
          this.setSizeHead();
          parser.parseURL(RSSURL)
            .then((feed) => {
                this.image = feed.image;
            }).catch((error) => {
                console.error(error)
            })
        }, 50);
      })
      .catch(error => {
        console.error("error in loading: ", error);
      });
    // this.$modal.show("voted");
    // this.$modal.show("loading");
    // this.$modal.show("error");
    // this.$modal.show("added");
    // this.$modal.show("checkEmail");
    // this.openRegister();
    // this.openAdd();
    // this.$modal.show("fail-add");
    // this.$modal.show("fail-vote");
    firebaseLib.auth().onAuthStateChanged(user => {
      this.loggin = user;
      if (this.loggin && this.loggin.displayName === null) {
        this.$router.push("/login");
      }
    });

  },
  firestore: {
    // people: db.collection("people").orderBy("votes", "desc")
  }
};
</script>

<style scoped>

.top {
  top: 0;
}
::-webkit-scrollbar {
  width: 10px;
}
.custom-scroll {
  overflow-y: scroll;
  position: absolute;
  overflow-x: hidden;
  /* height: 600px; */
  margin-left: -15px;
}
/* Track */
::-webkit-scrollbar-track {
  background: #f1f1f1;
}

/* Handle */
::-webkit-scrollbar-thumb {
  background: rgba(75, 39, 155, 1);
}

.fit-content {
  width: fit-content;
}

/* Handle on hover */
::-webkit-scrollbar-thumb:hover {
  background: #df99d8 !important;
}
</style>
